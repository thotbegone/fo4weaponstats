<!DOCTYPE html>
<html>
  <head>
    <title>Fo4 Weapon Stats</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <link rel="icon" href="assets/favicon.png">
    <link rel="stylesheet" href="vendor/bootstrap.css">
    <style type="text/css">

      html {
        overflow-y: scroll;
        height: 100%;
        width: 100%
      }

      .customDiv {
        padding-bottom: 10px;
      }

    </style>
  </head>

  <body onbeforeunload="exitFunc()">

    <div class="container">
      <div class="row">
        <div class="col">
          <br>
          <h1>Fallout 4 Weapon Stats</h1>
          <hr>
          <p>
            Choose weapon:&nbsp;
            <select id="weaponChoice" onchange="newWeapon()">
              <option value="none">None</option>
            </select>
          </p>
          <div id="modDivs"></div>
        </div>
        <div class="col">
          <br>
          <p>This tool was created, originally, out of necessity. Searching the internet,  I couldn't find anything that allowed for these calculations. <br><br>Weapon files take a while to put together, due to all the mods having different effects on every weapon. Since there is no consistency, everything is manual.</p>
        </div>
      </div>
    </div>

    <script src="vendor/jquery-3.4.1.min.js"> </script>
    <script src="vendor/bootstrap.bundle.js"> </script>
    <script src="vendor/pouchdb-7.0.0.js"> </script>
    <script>

      var globaldoc;

      var remote = new PouchDB('https://3b70a24c-52f8-4c44-b528-8b5c3cf7f959-bluemix.cloudantnosqldb.appdomain.cloud/fo4weapons');

      var local = new PouchDB('fo4weapons');

      local.replicate.from(remote).then(function(){
        listWeapons();
      });

      function listWeapons(){
        var drop = document.getElementById('weaponChoice');
        local.allDocs({include_docs : true}, function(err,response){
          if(err){
            console.log(err);
          }
          else{
            for(i=0;i<response.rows.length;i++){
              var id = response.rows[i].id;
              var name = response.rows[i].doc.name;
              var option = document.createElement('option');
              option.text = name;
              option.value = id;
              drop.add(option);
            }
          }
        });
      }

      function newWeapon(){
        document.getElementById('modDivs').innerHTML = '';
        var weaponID = document.getElementById('weaponChoice').value;
        var dropDiv = document.getElementById('modDivs');
        local.get(weaponID).then(function(doc){
          console.log(doc);
          globaldoc = doc;
          var mods = Object.entries(doc.modifications);
          var keys = Object.keys(doc.modifications);
          var baseObj = Object.keys(doc.base);
          // CREATE READONLY INPUTS OF CURRENT VALUES
          for(i=0;i<baseObj.length;i++){
            var tempdiv = document.createElement('div');
            tempdiv.setAttribute('class', 'customDiv');
            // thanks stackoverflow string[0].toUpperCase() + string.substring(1)
            var lowercaseName = baseObj[i];
            console.log(baseObj[i])
            var uppercaseName = lowercaseName[0].toUpperCase() + lowercaseName.substring(1);
            tempdiv.innerHTML = uppercaseName + ':&nbsp;';
            var inp = document.createElement('input');
            inp.setAttribute('value', doc.base[baseObj[i]]);
            inp.setAttribute('id', baseObj[i]);
            inp.setAttribute('readonly', true);
            tempdiv.appendChild(inp);
            dropDiv.appendChild(tempdiv);
          }
          // CREATE DROPDOWNS FOR MODS
          for(k=0;k<keys.length;k++){
            // CREATE CUSTOM DIV
            console.log('forlooop', keys[k]);
            var custDiv = document.createElement('div');
            custDiv.setAttribute('class', 'customDiv');
            custDiv.innerHTML = keys[k] + ':&nbsp;';
            // CREATE SELECT ELEMENT
            var selTemp = document.createElement('select');
            // DEFINE SOME VALUES FROM JSON
            var currMod = doc.modifications[keys[k]];
            var currModKeys = Object.keys(currMod);
            var currModVals = Object.values(currMod);
            // ASSIGN SELECT ID OF BARREL/MUZZLE/RECEIVER etc
            selTemp.setAttribute('id', keys[k]);
            selTemp.setAttribute('data-mod', currModKeys[0]);
            selTemp.setAttribute('onchange', 'valChange(this.id, this.value, this.dataset.mod)')
            // LOOP THROUGH ALL ENTRIES IN THE FILE MODS
            // NOW ACTUALLY LOOP THROUGH ALL THE OPTIONS WITHIN THE MOD
            for(v=0;v<currModKeys.length;v++){
              var tempOpt = document.createElement('option');
              tempOpt.innerHTML = currModKeys[v];
              tempOpt.setAttribute('value', currModKeys[v]);
              // ADD EACH ENTRY TO THE DROPDOWN CORRESPONDING WITH IT
              selTemp.add(tempOpt);
            }
            // PUSH THE DROP
            custDiv.appendChild(selTemp);
            dropDiv.appendChild(custDiv);
          }
        });
      }

      async function valChange(modId, modValue, dataMod){
        var proc = await subTractOld(modId, dataMod);
        console.log('mod/value', modId, modValue);
        var weapPart = globaldoc.modifications[modId];
        var partMod = weapPart[modValue];
        console.log(weapPart, partMod);
        console.log('loop start');
        // start meat
        // create list of keys
        var x = Object.keys(partMod);
        console.log(x);
        // loop thru all keys
        for(z=0;z<x.length;z++){
          // if key has corresponding element, do somethin
          if(document.getElementById(x[z]) == null){
            console.log('null id for', x[z]);
          }
          else {
            var currVal = document.getElementById(x[z]).value;
            document.getElementById(x[z]).value = parseFloat(parseFloat(currVal).toPrecision(4)) + parseFloat(parseFloat(partMod[x[z]]).toPrecision(4));
          }
        }

        //
       document.getElementById(modId).dataset.mod = modValue;
      }

      function subTractOld(part, mod) {
        // get current globaldoc and select the part
        var docMod = globaldoc.modifications[part];
        var modVal = docMod[mod];
        // get all keys. this will function as our list of elements to change
        var modKeys = Object.keys(modVal);
        // loop through all values and subtract, same as past loop
        for(i=0;i<modKeys.length;i++){
          if(document.getElementById(modKeys[i]) == null){
            console.log('no element for', modKeys[i]);
          }
          else {
            console.log('reached else statement for', modKeys[i]);
            var currVal = document.getElementById(modKeys[i]).value;
            document.getElementById(modKeys[i]).value = parseFloat(currVal) + (-1 * parseFloat(modVal[modKeys[i]]));
          }
        }
        return true;
      }

      function testID() {
        console.log(document.getElementById('gay'));
      }

    </script>
  </body>
</html>
