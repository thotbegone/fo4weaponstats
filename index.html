<!DOCTYPE html>
<html>
  <head>
    <title>Fo4 Weapon Stats</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <link rel="icon" href="assets/favicon.png">
    <link rel="stylesheet" href="vendor/bootstrap.css">
    <style type="text/css">

      html {
        overflow-y: scroll;
        height: 100%;
        width: 100%
      }

      .customDiv {
        padding-bottom: 10px;
      }

    </style>
  </head>

  <body onbeforeunload="exitFunc()">

    <div class="container">
      <div class="row">

        <div class="col">
          <br>
          <h1>Fallout 4 Weapon Stats</h1>
          <hr>
          <p>
            Weapon:&nbsp;
            <select id="weaponChoice" onchange="newWeapon()">
              <option value="none">None</option>
            </select>
          </p>
          <hr>
          <div id="modDivs"></div>
        </div>

        <div class="col">
          <br>
          <p>
            This tool was created, originally, out of necessity. Searching the internet,  I couldn't find anything that allowed for these calculations. <br><br>Weapon files take a while to put together, due to all the mods having different effects on every weapon. Since there is no consistency, everything is manual.
          </p>
        </div>

      </div>
    </div>

    <script src="vendor/jquery-3.4.1.min.js"> </script>
    <script src="vendor/bootstrap.bundle.js"> </script>
    <script src="vendor/pouchdb-7.0.0.js"> </script>
    <script>

      var globaldoc;

      var remote = new PouchDB('https://3b70a24c-52f8-4c44-b528-8b5c3cf7f959-bluemix.cloudantnosqldb.appdomain.cloud/fo4weapons');

      var local = new PouchDB('fo4weapons');

      local.replicate.from(remote).then(function(){
        listWeapons();
      });

      function listWeapons(){
        // LIST ALL THE WEAPONS IN THE DATABASE
        var drop = document.getElementById('weaponChoice');
        local.allDocs({include_docs : true}, function(err,response){
          if(err){
            console.log(err);
          }
          else{
            for(i=0;i<response.rows.length;i++){
              var id = response.rows[i].id;
              var name = response.rows[i].doc.name;
              var option = document.createElement('option');
              option.text = name;
              option.value = id;
              drop.add(option);
            }
          }
        });
      }

      function newWeapon(){
        // CLEAR DIV
        document.getElementById('modDivs').innerHTML = '';
        var weaponID = document.getElementById('weaponChoice').value;
        var dropDiv = document.getElementById('modDivs');
        local.get(weaponID).then(function(doc){
          // SET GLOBALDOC WHICH IS USED BY OTHER FUNCTIONS
          globaldoc = doc;
          var mods = Object.entries(doc.modifications);
          var keys = Object.keys(doc.modifications);
          var baseObj = Object.keys(doc.base);
          // CREATE READONLY INPUTS OF BASE VALUES
          for(i=0;i<baseObj.length;i++){
            // CREATE A LOAD OF ELEMENTS DEPENDING ON DOCUMENT
            // Thanks stackoverflow ( string[0].toUpperCase() + string.substring(1) )
            var tempdiv = document.createElement('div');
            tempdiv.setAttribute('class', 'customDiv');
            var lowercaseName = baseObj[i];
            var uppercaseName = lowercaseName[0].toUpperCase() + lowercaseName.substring(1);
            tempdiv.innerHTML = uppercaseName + ':&nbsp;';
            var inp = document.createElement('input');
            inp.setAttribute('value', doc.base[baseObj[i]]);
            inp.setAttribute('id', baseObj[i]);
            inp.setAttribute('readonly', true);
            tempdiv.appendChild(inp);
            dropDiv.appendChild(tempdiv);
          }
          // CREATE DROPDOWNS FOR MODS
          for(k=0;k<keys.length;k++){
            // CREATE CUSTOM DIV
            var custDiv = document.createElement('div');
            custDiv.setAttribute('class', 'customDiv');
            custDiv.innerHTML = keys[k] + ':&nbsp;';
            // CREATE SELECT ELEMENT
            var selTemp = document.createElement('select');
            // DEFINE SOME VALUES FROM JSON
            var currMod = doc.modifications[keys[k]];
            var currModKeys = Object.keys(currMod);
            var currModVals = Object.values(currMod);
            // ASSIGN SELECT ID OF BARREL/MUZZLE/RECEIVER etc
            selTemp.setAttribute('id', keys[k]);
            selTemp.setAttribute('data-mod', currModKeys[0]);
            selTemp.setAttribute('onchange', 'valChange(this.id, this.value, this.dataset.mod)')
            // LOOP THROUGH ALL ENTRIES IN THE MODS
            for(v=0;v<currModKeys.length;v++){
              var tempOpt = document.createElement('option');
              tempOpt.innerHTML = currModKeys[v];
              tempOpt.setAttribute('value', currModKeys[v]);
              // ADD EACH TO THE DIV
              selTemp.add(tempOpt);
            }
            // PUSH THE DROP/S
            custDiv.appendChild(selTemp);
            dropDiv.appendChild(custDiv);
          }
        });
      }

      async function valChange(modId, modValue, dataMod){
        // ASYNC FOR PEACE OF MIND THAT THE SUBTRACTION WILL COMPLETE BEFORE THE DATA-MOD TAG GETS UPDATED
        var proc = await subTractOld(modId, dataMod);
        // GET VALUES FROM GLOBALDOC
        var weapPart = globaldoc.modifications[modId];
        var partMod = weapPart[modValue];
        // CREATE LIST OF KEYS
        var modKeys = Object.keys(partMod);
        // LOOP THROUGH ALL KEYS
        for(z=0;z<modKeys.length;z++){
          // IF KEY HAS A CORRESPONDING ELEMENT, ADD VALUES
          if(document.getElementById(modKeys[z]) == null){
            console.log('null id for', modKeys[z]);
          }
          else {
            var currVal = document.getElementById(modKeys[z]).value;
            var tempVal = parseFloat(currVal) + parseFloat(partMod[modKeys[z]]);
            // ROUND TO 1 DECIMAL PLACE
            document.getElementById(modKeys[z]).value = Math.round(tempVal * 10) / 10;
          }
        }
        // UPDATE DATA-MOD TO NEW MOD
       document.getElementById(modId).dataset.mod = modValue;
      }

      function subTractOld(part, mod) {
        // GET GLOBALDOC
        var docMod = globaldoc.modifications[part];
        var modVal = docMod[mod];
        // GET KEYS
        var modKeys = Object.keys(modVal);
        // LOOP THROUGH VALUES, SAME AS LAST TIME
        for(i=0;i<modKeys.length;i++){
          if(document.getElementById(modKeys[i]) == null){
            console.log('no element for', modKeys[i]);
          }
          else {
            console.log('reached else statement for', modKeys[i]);
            var currVal = document.getElementById(modKeys[i]).value;
            document.getElementById(modKeys[i]).value = parseFloat(currVal) + (-1 * parseFloat(modVal[modKeys[i]]));
          }
        }
        // RETURN TRUE TO SATISFY THE AWAIT
        return true;
      }

    </script>
  </body>
</html>
